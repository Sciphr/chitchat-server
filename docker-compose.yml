services:
  chitchat:
    image: sciphr/chitchat-server:latest
    restart: unless-stopped
    env_file:
      - path: .env
        required: false
    environment:
      PORT: 3001
      DB_PATH: /app/data/chitchat.db
      DATA_DIR: /app/data
      ADMIN_EMAIL: ${ADMIN_EMAIL:-}
      ADMIN_USERNAME: ${ADMIN_USERNAME:-}
      ADMIN_PASSWORD: ${ADMIN_PASSWORD:-}
      LIVEKIT_URL: ${LIVEKIT_URL:-ws://livekit:7880}
      LIVEKIT_API_KEY: ${LIVEKIT_API_KEY:-}
      LIVEKIT_API_SECRET: ${LIVEKIT_API_SECRET:-}
      FILES_AV_ENABLED: ${FILES_AV_ENABLED:-true}
      FILES_AV_PROVIDER: ${FILES_AV_PROVIDER:-clamav}
      FILES_AV_CLAMAV_HOST: ${FILES_AV_CLAMAV_HOST:-clamav}
      FILES_AV_CLAMAV_PORT: ${FILES_AV_CLAMAV_PORT:-3310}
      FILES_AV_TIMEOUT_MS: ${FILES_AV_TIMEOUT_MS:-15000}
      FILES_AV_FAIL_CLOSED: ${FILES_AV_FAIL_CLOSED:-true}
    depends_on:
      - livekit
    ports:
      - "${HOST_PORT:-3001}:3001"
    volumes:
      - chitchat_data:/app/data

  livekit:
    image: livekit/livekit-server:latest
    restart: unless-stopped
    command: ["--config", "/etc/livekit.yaml"]
    environment:
      LIVEKIT_KEYS: "${LIVEKIT_API_KEY}: ${LIVEKIT_API_SECRET}"
    ports:
      - "${LIVEKIT_PORT:-7880}:7880/tcp"
      - "${LIVEKIT_UDP_PORT_START:-50000}-${LIVEKIT_UDP_PORT_END:-50100}:${LIVEKIT_UDP_PORT_START:-50000}-${LIVEKIT_UDP_PORT_END:-50100}/udp"
    volumes:
      - ./deploy/livekit/livekit.yaml:/etc/livekit.yaml:ro

  clamav:
    image: clamav/clamav:stable
    restart: unless-stopped
    expose:
      - "3310"
    volumes:
      - clamav_db:/var/lib/clamav

volumes:
  chitchat_data:
  clamav_db:
